---
title: "6章.AMCLで自己位置推定する"
source: "https://qiita.com/motoms/items/1dc0172f13641c1f1d8a"
author:
  - "[[motoms]]"
published: 2022-03-06
created: 2025-08-26
description: "本章の流れ ここまで来れば自動航行まであと一歩！前章で行ったSLAMを使い、作った地図から自己位置推定を行ってみようと思います。本章では以下の流れで進めていきます。 1.AMCLの概要 2.AMCLの必要性 3.SLAMから地図を保存する 4.保存した地図からAMCLを使..."
tags:
  - "clippings"
---
![](https://relay-dsp.ad-m.asia/dmp/sync/bizmatrix?pid=c3ed207b574cf11376&d=x18o8hduaj&uid=)

この記事は最終更新日から3年以上が経過しています。

## 本章の流れ

ここまで来れば自動航行まであと一歩！前章で行ったSLAMを使い、作った地図から自己位置推定を行ってみようと思います。本章では以下の流れで進めていきます。

1.AMCLの概要  
2.AMCLの必要性  
3.SLAMから地図を保存する  
4.保存した地図からAMCLを使って自己位置推定する  
5.AMCLって...  
6.EMCLを使ってみる  
7.今までの道のり  
8.参考文献

## 1.AMCLの概要

AMCLの概要について以下を引用させてもらいます。  
[LiDARとAMCLを用いた自己位置推定](https://uenota.github.io/dronedoc/ja/slam/lidar_localization.html)  
モンテカルロ位置推定（Monte Carlo Localization）は、パーティクルフィルタを用いて自己位置推定を行う手法です。このアルゴリズムではロボットの位置の確率分布をパーティクルの分布で表現し、その分布を、観測した情報を元に更新することで自己位置の推定を行います。  
適応的モンテカルロ位置推定（Adaptive Monte Carlo Localization）は、モンテカルロ位置推定で用いる粒子の数を動的に調整することのできるアルゴリズムです。  
  
　以下の図の様にAMCLによってODOMとMAPつなぎ合わせる役目であると私は思っております。  
[![AMCL説明.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/212663/c2b7c4bc-5421-d8e3-41e0-96e14e8e4685.png)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F212663%2Fc2b7c4bc-5421-d8e3-41e0-96e14e8e4685.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=f5b7358e346d3d55e5e6baa4621c4169)

## 2.AMCLの必要性

　ではなぜAMCLが必要かというと、SLAMを使ってずっと地図を作成していると、以下の様に同じ場所を何度も上書きしていくうちに、オドメトリの誤差やスキャンのノイズによって地図がぐちゃぐちゃになっていくことがあります。そのため自動航行を使って何度も同じ動作をさせるような場合、地図は綺麗な状態を保ちつつ、地図の中で自分がどこにいるのか把握するためAMCLが必要だと思っています。  
[![図：同じ場所を何度も上書きし、ぐちゃぐちゃになった地図](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/212663/8cef195b-7a46-8b9a-2ebc-cd7fb487c61d.png)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F212663%2F8cef195b-7a46-8b9a-2ebc-cd7fb487c61d.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=52d1105a59c35621598325d7361e55de)  
　上記のようにずっとSLAMを実行していくわけにも行かないため、ここまで来るとオドメトリを正確に配信出来る機器が必要になります。ホイールエンコーダによってオドメトリを取得するか、RealsenseT265やZED2等でオドメトリを取得するのもアリです。ホイールエンコーダでオドメトリを取得する場合、センサ系でオドメトリを取得する場合それぞれで一長一短があると思いますが、ホイールエンコーダでオドメトリを取得した際に凹凸のある地面やホイールの空転によって実際の位置から急激に変化してしまうことも経験し、現在はセンサ系でオドメトリを取得しています。今後RealsenseT265は販売が徐々に無くなっていくため、私のオススメはZED2です。ZED2であればデプスカメラ+オドメトリがあるため1式でロボットで利用するセンサを集約させることが出来ます。またデプスカメラとオドメトリ（IMU)センサをそれぞれ単体で購入するよりも安く手に入ると思います。

[ZED2](https://www.stereolabs.com/zed-2/)

## 3.SLAMから地図を保存する

　このAMCLを実行するには基となる地図が必要です。そのため前章で行ったSLAMを実行した後、map\_serverパッケージの中にあるmap\_saverを使って地図を保存してみます。  
　まずは前章のおさらいとしてRPLiDAR\_A1を使ってgmappingでSLAMを起動してみます。

rplidar.launchの起動

```bash
$ source ~/catkin_ws/devel/setup.bash
$ roslaunch rplidar_ros rplidar.launch
```

別のターミナルを開きgmappingを起動する

gbot.launchの起動（RPLiDAR\_A1でcartgrapher起動）

```bash
$ source ~/catkin_ws/devel/setup.bash
$ roslaunch gmapping gmapping.launch
```

その後別のターミナルを開きmap\_saverを使って地図を保存してみます。

map\_saverの起動（地図の保存）

```bash
$ source ~/catkin_ws/devel/setup.bash
$ rosrun map_server map_saver -f map_20220306
```

このときの”map\_20211226”はファイル名となるので、任意の名前を付けて下さい。  
上記の場合、homeのディレクトリにmap\_20220306.pgmとmap\_20220306.yamlが生成されていると思います。  
homeディレクトリに保管されている状態では使いにくいので、以下の様な場所にmapディレクトリを作って上記2ファイルを移動して見て下さい。

mapファイルの移動

```bash
$ cd  ~/catkin_ws/src
$ catkin_create_pkg map
$ cd map
$ mkdir map
$ cd ~/
$ mv map_20220306.pgm map_20220306.yaml ~/catkin_ws/src/map/map
$ cd catkin_ws/
$ catkin_make
$ source ~/catkin_ws/devel/setup.bash
```

ちなみに地図を作る上で実行するSLAMについては、5章で行った３タイプのどれであっても下記の地図を作成出来ると思っております。  
[5章.SLAMを使ってみる](https://qiita.com/drafts/4c45f75911e210088ea1/edit)

この地図を使ってAMCLを行ってみようと思います。

## 4.保存した地図からAMCLを使って自己位置推定する

私が自動航行を学習する上でお世話になったのはHUSKYと呼ばれているUGVのGitリポジトリです。検討していた機体と似ており、かつGazaboやSLAM等一通りの内容が含まれており、今回のAMCLについても簡単に動作するものが含まれております。そのためこちらを参考にしてAMCLを動かしてみます。  
参考（HUSKY）： [http://wiki.ros.org/Robots/Husky](http://wiki.ros.org/Robots/Husky)  
　こちらのHUSKYのリポジトリをクローンしてみます。

HUSKYのリポジトリをクローン+ビルド

```bash
$ cd  ~/catkin_ws/src
$ git clone https://github.com/husky/husky.git
$ cd ..
$ catkin_make
$ source ~/catkin_ws/devel/setup.bash
```

この中にあるhusky\_navigationのlaunchディレクトリにあるamcl\_demo.launcを修正してみます。

amcl\_demo.launcを修正

```xml
<?xml version="1.0"?>
<!--
Software License Agreement (BSD)

\file      amcl_demo.launch
\authors   Paul Bovbel <pbovbel@clearpathrobotics.com>, Prasenjit Mukherjee <pmukherj@clearpathrobotics.com>
\copyright Copyright (c) 2015, Clearpath Robotics, Inc., All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that
the following conditions are met:
 * Redistributions of source code must retain the above copyright notice, this list of conditions and the
   following disclaimer.
 * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the 
   following disclaimer in the documentation and/or other materials provided with the distribution.
 * Neither the name of Clearpath Robotics nor the names of its contributors may be used to endorse or promote
   products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WAR-
RANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, IN-
DIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<launch>

  <!-- Run the map server -->
  <!--<arg name="map_file" default="$(find husky_navigation)/maps/playpen_map.yaml"/>ｰｰ>
  
  <!-- ↓↓↓以下を修正し作成したmapファイルで動かせるようにします↓↓↓ -->
  <arg name="map_file" default="$(find map)/map/map_20220306.yaml"/>
  
  <node name="map_server" pkg="map_server" type="map_server" args="$(arg map_file)" />

  <!--- Run AMCL -->
  <include file="$(find husky_navigation)/launch/amcl.launch" />

  <!--- Run Move Base -->
  <include file="$(find husky_navigation)/launch/move_base.launch" />

</launch>
```

これでAMCLが使えるようになります。AMCLを使って簡単に自動航行をしてみましょう。ここで起動する内容は以下となります。

**【自動航行における動作手順】**  
①cmd\_velトピックで動き、オドメトリを出力出来るロボットを起動する（1章参照）  
②LIDARによってscanトピックを出力させる(rplidar.launchを起動）  
③map\_serverに自分の作った地図を読み込ませる  
④AMCLを使って自己位置推定し、地図上のどこにいるか推定する←本章のテーマ  
⑤move\_baseを使って自動航行させる。

この時①は各自で作成したロボットで実行して下さい。  
次の②をLIDARによってscanトピックを出力させます。

②rplidar.launchの起動

```bash
$ source ~/catkin_ws/devel/setup.bash
$ roslaunch rplidar_ros rplidar.launch
```

　このあと②、③、④を一気に起動させます

　これで簡単な自動航行の環境は整いました。2D Pose Estimateや2D Nav Goalの使い方はYouTube等でご確認下さい。  
参考までに分かりやすかったURLを貼っておきます。  
[Autonomous navigation robot with ROS (Raspberry pi + YDLIDAR)](https://www.youtube.com/watch?v=Gsx4gJVk0UY)

## 5.AMCLって...

しかし実際AMCLを使って2D Pose Estimateをマウスで一生懸命設定しても、以下の図の様に中々自己位置が収束しない場面に出くわす人も多いのではないかと思っています。  
[![ワークスペース 1_027.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/212663/0678a6af-fce0-08ab-2bab-ad8eac7b6e97.png)](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F212663%2F0678a6af-fce0-08ab-2bab-ad8eac7b6e97.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=9e8edce94c988ab7f04ca483e2671f9e)

## 6.EMCLを使ってみる

　中々自己位置が収束しない問題に対して何か良いモノは無いかと探していたところ、以下の素晴らしい内容を見つけました！ $EMCLです！！$  
こちらでご紹介されている様に、2D Pose Estimateで指定した位置に本当に上手く合わせてくれます。感謝しか無いです！  
[真面目にamclの代替ROSパッケージを作った](http://b.ueda.tech/?post=20210505)

EMCLのリポジトリをクローン+ビルド

```bash
$ cd  ~/catkin_ws/src
$ git clone https://github.com/ryuichiueda/emcl.git
$ cd ..
$ catkin_make
$ source ~/catkin_ws/devel/setup.bash
```

amcl.launchの代わりにemcl.launch使えば簡単に出来ました。ただemcl.launchの中にあるパラメータにおいてbase\_footprintを環境に応じてbase\_linkに変えることや、initial\_poseを変えることは適宜調整してみて下さい。  
  
　これがあればあとは最終章、自動航行（move\_base）のみとなります！  
細い道でも入って行けるようにしたり、障害物を回避する際のチューニング方法等も含めてご説明できればと思っております。  
$乞うご期待！！$

## 7.今までの道のり

[作って分かった「ROSを使う前のロボットと、ROSを使った後のロボットの変化」](https://qiita.com/motom0509/items/1e1b6866eba52dcdf90b)

目次： [ROSを使った自動航行ロボットをつくるまでの道のり　ー序章　概要ー](https://qiita.com/motom0509/items/ea297fffbd6865b85bdb)  
[1章.ロボットのROS対応](https://qiita.com/motom0509/items/c81d85b2e7967a780eb9)  
[2章.ロボットを操作する](https://qiita.com/motom0509/items/e5b3310c248b23f36ef7)  
[3章.LiDARを動かす](https://qiita.com/motom0509/items/382bfcee80aa05f5dcd9)  
[4章.urdfを作成する](https://qiita.com/motoms/items/a67b272313d7737a6b43)  
前章 ： [5章.SLAMを使ってみる](https://qiita.com/drafts/4c45f75911e210088ea1/edit)

## 8.参考文献

[LiDARとAMCLを用いた自己位置推定](https://uenota.github.io/dronedoc/ja/slam/lidar_localization.html)  
[ROS講座91 Laserでmap位置を推定する](https://qiita.com/srs/items/b07a22425548c41bfd04)  
[2DレーザーのみでGoogle Cartographer ros](https://ssk0109.hatenablog.com/entry/2018/12/06/032727)  
[HUSKY](http://wiki.ros.org/Robots/Husky)  
[Autonomous navigation robot with ROS (Raspberry pi + YDLIDAR)](https://www.youtube.com/watch?v=Gsx4gJVk0UY)  
[真面目にamclの代替ROSパッケージを作った](http://b.ueda.tech/?post=20210505)

[0](https://qiita.com/motoms/items/#comments)

コメント一覧へ移動

X（Twitter）でシェアする

Facebookでシェアする

はてなブックマークに追加する

新規登録して、もっと便利にQiitaを使ってみよう

1. あなたにマッチした記事をお届けします
2. 便利な情報をあとで効率的に読み返せます
3. ダークテーマを利用できます
[ログインすると使える機能について](https://help.qiita.com/ja/articles/qiita-login-user)

[新規登録](https://qiita.com/signup?callback_action=login_or_signup&redirect_to=%2Fmotoms%2Fitems%2F1dc0172f13641c1f1d8a&realm=qiita) [ログイン](https://qiita.com/login?callback_action=login_or_signup&redirect_to=%2Fmotoms%2Fitems%2F1dc0172f13641c1f1d8a&realm=qiita)

[19](https://qiita.com/motoms/items/1dc0172f13641c1f1d8a/likers)

いいねしたユーザー一覧へ移動

12